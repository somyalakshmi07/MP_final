trigger:
  branches:
    include:
      - main

variables:
  acrName: acrecomsecure12345
  acrConnection: acr-prod-connection
  aksCluster: aks-private-ecommerce
  resourceGroup: rg-ecommerce
  helmChartPath: helm/eCommerce
  kubernetesServiceConnection: azure-rm-prod
  imageTag: '$(Build.BuildId)'

stages:
- stage: Build
  displayName: Build & Push Images
  jobs:
  - job: BuildImages
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Bash@3
      displayName: Login to ACR (Manual Auth)
      inputs:
        targetType: 'inline'
        script: |
          echo "$ACR_PASSWORD" | docker login $(acrName).azurecr.io -u "$ACR_USERNAME" --password-stdin
      env:
          ACR_USERNAME: $(ACR_USERNAME)
          ACR_PASSWORD: $(ACR_PASSWORD)

    - task: Docker@2
      displayName: Build & Push Frontend
      inputs:
        command: buildAndPush
        containerRegistry: $(acrConnection)
        repository: frontend
        dockerfile: frontend/Dockerfile
        tags: |
          $(imageTag)

    - task: Docker@2
      displayName: Build & Push Gateway Service
      inputs:
        command: buildAndPush
        containerRegistry: $(acrConnection)
        repository: gateway-service
        dockerfile: gateway-service/Dockerfile
        tags: |
          $(imageTag)

    - task: Docker@2
      displayName: Build & Push Auth Service
      inputs:
        command: buildAndPush
        containerRegistry: $(acrConnection)
        repository: auth-service
        dockerfile: auth-service/Dockerfile
        tags: |
          $(imageTag)

    - task: Docker@2
      displayName: Build & Push Catalog Service
      inputs:
        command: buildAndPush
        containerRegistry: $(acrConnection)
        repository: catalog-service
        dockerfile: catalog-service/Dockerfile
        tags: |
          $(imageTag)

    - task: Docker@2
      displayName: Build & Push Cart Service
      inputs:
        command: buildAndPush
        containerRegistry: $(acrConnection)
        repository: cart-service
        dockerfile: cart-service/Dockerfile
        tags: |
          $(imageTag)

    - task: Docker@2
      displayName: Build & Push Order Service
      inputs:
        command: buildAndPush
        containerRegistry: $(acrConnection)
        repository: order-service
        dockerfile: order-service/Dockerfile
        tags: |
          $(imageTag)

    - task: Docker@2
      displayName: Build & Push Payment Service
      inputs:
        command: buildAndPush
        containerRegistry: $(acrConnection)
        repository: payment-service
        dockerfile: payment-service/Dockerfile
        tags: |
          $(imageTag)

    - task: Docker@2
      displayName: Build & Push Admin Service
      inputs:
        command: buildAndPush
        containerRegistry: $(acrConnection)
        repository: admin-service
        dockerfile: admin-service/Dockerfile
        tags: |
          $(imageTag)

- stage: Deploy
  displayName: Deploy to Private AKS
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: Deploy
    environment: production-secure
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
          - task: AzureCLI@2
            displayName: Configure kubectl for AKS
            inputs:
              azureSubscription: $(kubernetesServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az aks get-credentials --resource-group $(resourceGroup) --name $(aksCluster) --overwrite-existing

          - script: ls -R
            displayName: 'List files in repository'

          - task: HelmDeploy@0
            displayName: Deploy Helm Chart
            inputs:
              connectionType: Azure Resource Manager
              azureSubscription: $(kubernetesServiceConnection)
              azureResourceGroup: $(resourceGroup)
              kubernetesCluster: $(aksCluster)
              namespace: default
              command: upgrade
              chartType: FilePath
              chartPath: $(helmChartPath)
              releaseName: ecommerce-secure
              valueFile: $(helmChartPath)/values.yaml
              install: true
              arguments: >
                --atomic
                --timeout 10m
                --set global.image.tag=$(imageTag)
                --set global.image.repository=$(acrName).azurecr.io
