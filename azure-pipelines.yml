trigger:
  branches:
    include:
      - main
      - master


variables:
  ACR_NAME: acrecomsomyaea123.azurecr.io
  AKS_RG: rg-ecommerce-arm
  AKS_NAME: aks-ecommerce-eastasia
  NAMESPACE: ecommerce

stages:
# ===============================
# STAGE 1: BUILD & PUSH IMAGES
# ===============================
- stage: BuildAndPush
  displayName: Build & Push Docker Images
  jobs:
  - job: DockerBuild
    displayName: Docker Build Job
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: Build & Push to ACR
      inputs:
        azureSubscription: sc-aks-acr-mi
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          echo "üîê Logging into ACR"
          az acr login --name acrecomsomyaea123

          echo "üì¶ Using ACR: $(ACR_NAME)"

          SERVICES=(
            auth-service
            cart-service
            catalog-service
            order-service
            payment-service
            frontend
            gateway-service
          )

          for SERVICE in "${SERVICES[@]}"; do
            echo "üöÄ Building $SERVICE"
            docker build \
              -t $(ACR_NAME)/$SERVICE:latest \
              ./$SERVICE

            echo "üì§ Pushing $SERVICE"
            docker push $(ACR_NAME)/$SERVICE:latest
          done
# ===============================
# STAGE 2: DEPLOY TO AKS
# ===============================
- stage: DeployToAKS
  displayName: Deploy to AKS
  dependsOn: BuildAndPush
  jobs:
  - job: Deploy
    displayName: AKS Deployment Job
    pool:
      vmImage: ubuntu-latest
    steps:
    - checkout: self

    - task: AzureCLI@2
      displayName: Deploy manifests to AKS
      inputs:
        azureSubscription: sc-aks-acr-mi
        scriptType: bash
        scriptLocation: inlineScript
        inlineScript: |
          set -e

          echo "üîë Fetching AKS credentials"
          az aks get-credentials \
            --resource-group $(AKS_RG) \
            --name $(AKS_NAME) \
            --overwrite-existing

          echo "üìÇ Applying Kubernetes manifests"
          kubectl apply -f k8s/ -n $(NAMESPACE)

          echo "üîÑ Restarting deployments"
          kubectl rollout restart deployment -n $(NAMESPACE)

          echo "‚úÖ Deployment completed successfully"
