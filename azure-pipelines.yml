trigger:
  branches:
    include:
      - main

variables:
  acrName: acrecomsomyaea123
  acrConnection: acr-prod-connection
  aksCluster: aks-private-ecommerce
  resourceGroup: rg-ecommerce
  helmChartPath: ./helm  # <-- FIXED (must be folder, not file path)
  kubernetesServiceConnection: azure-rm-prod
  imageTag: '$(Build.BuildId)'

stages:

# ------------------ BUILD + PUSH IMAGES ------------------
- stage: Build
  displayName: Build & Push Images
  jobs:
  - job: BuildImages
    pool:
      vmImage: ubuntu-latest

    steps:
    - checkout: self

    # ---- FIXED: REMOVE MSI AUTH ----
    - task: Bash@3
      displayName: Login to ACR (Manual Authentication)
      inputs:
        targetType: 'inline'
        script: |
          echo "$ACR_PASSWORD" | docker login $(acrName).azurecr.io -u "$ACR_USERNAME" --password-stdin
      env:
        ACR_USERNAME: $(ACR_USERNAME)
        ACR_PASSWORD: $(ACR_PASSWORD)

    # ---- BUILD & PUSH SERVICES ----
    - ${{ each svc in ['frontend','gateway-service','auth-service','catalog-service','cart-service','order-service','payment-service','admin-service'] }}:
      - task: Docker@2
        displayName: Build & Push ${{ svc }}
        inputs:
          command: buildAndPush
          containerRegistry: $(acrConnection)
          repository: ${{ svc }}
          dockerfile: ${{ svc }}/Dockerfile
          tags: |
            $(imageTag)

# ------------------ DEPLOY TO AKS ------------------
- stage: Deploy
  displayName: Deploy to Private AKS
  dependsOn: Build
  condition: succeeded()

  jobs:
  - deployment: Deploy
    environment: production-secure
    pool:
      vmImage: ubuntu-latest

    strategy:
      runOnce:
        deploy:
          steps:

          - task: AzureCLI@2
            displayName: Configure kubectl for AKS
            inputs:
              azureSubscription: $(kubernetesServiceConnection)
              scriptType: bash
              scriptLocation: inlineScript
              inlineScript: |
                az aks get-credentials --resource-group $(resourceGroup) --name $(aksCluster) --overwrite-existing

          # Debug for path confirmation
          - script: |
              echo "ðŸ” Directory structure:"
              pwd
              ls -R
            displayName: "Debug: List files"

          - task: HelmDeploy@0
            displayName: Deploy Helm Chart
            inputs:
              connectionType: Azure Resource Manager
              azureSubscription: $(kubernetesServiceConnection)
              azureResourceGroup: $(resourceGroup)
              kubernetesCluster: $(aksCluster)
              namespace: default
              command: upgrade
              chartType: FilePath
              chartPath: $(helmChartPath)  # <-- FIXED
              releaseName: ecommerce-secure
              valueFile: $(helmChartPath)/values.yaml
              install: true
              arguments: >
                --atomic
                --timeout 10m
                --set global.image.tag=$(imageTag)
                --set global.image.repository=$(acrName).azurecr.io
